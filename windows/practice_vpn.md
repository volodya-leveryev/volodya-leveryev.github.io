# Настройка VPN
### Цель
Настроить сервер VPN для того, чтобы работник находящийся в командировке мог подключиться к сетевым ресурсам в локальной сети предприятия.
### Теория
VPN — это виртуальные частные сети (Virtual Private Network) которые создаются поверх другой сети (обычно поверх Интернета).

На сегодняшний день наиболее популярными сетевыми протоколами использующимися для создания VPN являются:
  * PPTP — устаревший протокол. Использует небезопасные методы шифрования и аутентификации.
  * IPSec в связке с L2TP — надежное и распространенное решение. Работает с помощью портов UDP/500, UDP/1701, UDP/4500.
  * SSTP — современный безопасный протокол. Работает с помощью порта TCP/443.
  * OpenVPN — протокол с открытым исходным кодом. Требует установки стороннего ПО.
### Ход работы
1. Подключитесь к выделенному вам серверу.
2. Установите роль **Remote Access.**
3. Выберите службы роли **DirectAccess and VPN (RAS) и Routing.**
4. После завершения установки в мастере **Configure Remote Access (Getting Started)** нужно выбрать вариант **VPN only.**
5. В консоли **Routing and Remote** Access выберите в контекстном меню **Configure and Enable Routing and Remote Access** настройте работу в режиме **Custom configuration** с галочками **VPN access** и **NAT**.
6. В свойствах сервера на вкладке **IPv4** создайте новый пул адресов с диапазоном адресов `192.168.1.11 – 192.168.1.254`.
7. Откройте консоль **Computer Management**, перейдите в раздел **Local Users and Groups, Users** и создайте тестового пользователя и задайте ему пароль без срока истечения.
8. В свойствах пользователя на вкладке **Dial-in** разрешите доступ в разделе **Network Access Permission** (либо через Network Policy Server разрешите доступ к Dial-in для всех пользователей).
9. Для того чтобы клиенты VPN могли выходить в Интернет через сервер нужно в консоли **Routing and Remote Access** в разделе **IPv4 NAT** добавить два сетевых адаптера (один для частной сети - internal, второй для публичной сети - eth0 со включенным NAT)
10. Откройте консоль управления **IIS Manager**, выберите сервер, откройте его сертификаты и в панели **Actions** выберите **Create Self-signed Certificate** и придумайте для него имя (тип Personal).
11. Откройте свойства сертификата, на вкладке** Details** выберите **Copy to file**, сохраните его публичную часть в формате `*.cer` и скопируйте его на клиентский компьютер.
12. С помощью консоли **Routing and Remote Access** в свойствах сервера на вкладке **Security** выберите созданный сертификат.
13. На клиентском компьютере импортируйте созданный сертификат в контейнер **Trusted Root Certification Authorities** локального компьютера.
14. На клиентском компьютере добавьте запись в файл `C:\Windows\System32\drivers\hosts` с IP-адресом сервера и CN-именем в сертификате.
15. Проверьте подключение через **SSTP** со своего компьютера к серверу по имени компьютера из предыдущего пункта.
16. Проверьте что клиентский компьютер выходит в Интернет через удаленный сервер
### Ссылки
  * https://interface31.ru/tech_it/2020/11/nastraivaem-pptp-ili-l2tp-vpn-server-pri-pomoshhi-rras-v-windows-server.html
  * https://www.snel.com/support/how-to-set-up-an-l2tp-ipsec-vpn-on-windows-server-2019/
  * https://getanadmin.com/windowsserver/win2019/setup-a-secure-vpn-sstp-on-windows-server-2019/
  * https://msftwebcast.com/2020/02/configure-sstp-vpn-with-self-signed-certificate-on-windows-server-2019.html
